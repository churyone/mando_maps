<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>네이버 지도 GPS 웨이포인트</title>
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=u3fh3k13l2"></script>
    <style>
        #map {
            width: 100%;
            height: 750px;
        }
    </style>
</head>
<body>
    <h2>GPS 웨이포인트 찍기</h2>
    <div id="map"></div>
    <script>
        // 네이버 지도 초기화
        var mapOptions = {
            center: new naver.maps.LatLng(37.2887, 127.1069), // 서울의 위도, 경도
            zoom: 19.4,
            mapTypeControl: true // 지도 타입 컨트롤러 추가 (일반, 위성, 지형 등)
        };

        var map = new naver.maps.Map('map', mapOptions);

        // 파일에서 웨이포인트 데이터를 읽어오는 함수
        function loadWaypoints() {
            fetch('/convert_utm')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('웨이포인트 데이터를 불러오는 중 오류 발생: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.length === 0) {
                        console.error('웨이포인트 데이터가 비어 있습니다.');
                        return;
                    }
                    console.log('웨이포인트 데이터:', data); // 데이터 로깅
                    addMarkers(data);
                })
                .catch(error => console.error('데이터 불러오기 오류:', error));
        }

        // 각 웨이포인트에 마커 추가
        function addMarkers(waypoints) {
            waypoints.forEach(function(point, index) {
                try {
                    var markerPosition = new naver.maps.LatLng(point.lat, point.lng);

                    var marker = new naver.maps.Marker({
                        position: markerPosition,
                        map: map
                    });

                    // 마커에 정보창 추가
                    var infoWindow = new naver.maps.InfoWindow({
                        content: `<div style="width:150px;text-align:center;padding:10px;">
                                    <strong>웨이포인트 ${index + 1}</strong><br>
                                    위도: ${point.lat.toFixed(6)}<br>
                                    경도: ${point.lng.toFixed(6)}<br>
                                    설명: ${point.description}
                                </div>`
                    });

                    // 마커 클릭 시 정보창 및 거리뷰 열기
                    naver.maps.Event.addListener(marker, 'click', function() {
                        infoWindow.open(map, marker);

                        // 거리뷰 위치를 설정하고 활성화
                        pano.setPosition(marker.getPosition());
                        pano.setVisible(true);
                        console.log(`거리뷰 활성화 - 웨이포인트 인덱스: ${index}`);
                    });

                    console.log(`마커 추가 성공 - 웨이포인트 인덱스: ${index}, 위치: (${point.lat}, ${point.lng})`);
                } catch (e) {
                    console.error(`마커 추가 실패 - 웨이포인트 인덱스: ${index}`, e);
                }
            });
        }


        // 웨이포인트 파일 불러오기
        loadWaypoints();

        // 지도 타입을 변경하는 컨트롤러 추가
        var mapTypeControl = new naver.maps.MapTypeControl();
        map.addControl(mapTypeControl, {
            position: naver.maps.Position.TOP_RIGHT
        });

        // 줌 컨트롤 추가
        var zoomControl = new naver.maps.ZoomControl();
        map.addControl(zoomControl, {
            position: naver.maps.Position.RIGHT_CENTER
        });
    </script>
</body>
</html>